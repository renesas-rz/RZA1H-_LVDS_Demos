/***********************************************************************************************************************
 * DISCLAIMER
 * This software is supplied by Renesas Electronics Corporation and is only intended for use with Renesas products.
 * No other uses are authorized. This software is owned by Renesas Electronics Corporation and is protected under all
 * applicable laws, including copyright laws.
 * THIS SOFTWARE IS PROVIDED "AS IS" AND RENESAS MAKES NO WARRANTIESREGARDING THIS SOFTWARE, WHETHER EXPRESS, IMPLIED
 * OR STATUTORY, INCLUDING BUT NOT LIMITED TO WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NON-INFRINGEMENT.  ALL SUCH WARRANTIES ARE EXPRESSLY DISCLAIMED.TO THE MAXIMUM EXTENT PERMITTED NOT PROHIBITED BY
 * LAW, NEITHER RENESAS ELECTRONICS CORPORATION NOR ANY OF ITS AFFILIATED COMPANIES SHALL BE LIABLE FOR ANY DIRECT,
 * INDIRECT, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES FOR ANY REASON RELATED TO THIS SOFTWARE, EVEN IF RENESAS OR
 * ITS AFFILIATES HAVE BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.
 * Renesas reserves the right, without notice, to make changes to this software and to discontinue the availability
 * of this software. By using this software, you agree to the additional terms and conditions found by accessing the
 * following link:
 * http://www.renesas.com/disclaimer
 *
 * Copyright (C) 2015 Renesas Electronics Corporation. All rights reserved.
 ***********************************************************************************************************************/

/***********************************************************************************************************************
 * File Name     : r_camera_ov5642.c
 * Device(s)     : RZ/A1H
 * Tool-Chain    : GNUARM-NONEv16.01-EABI
 * H/W Platform  : RSK board
 * Description   : Routines for setting up and driving an Omnivision OV5642 Camera
 ***********************************************************************************************************************/

/***********************************************************************************************************************
 * History       : DD.MM.YYYY Version Description
 *               : 13.02.2017 1.00
 ***********************************************************************************************************************/

/***********************************************************************************************************************
 Includes
 ***********************************************************************************************************************/
#include "mcu_board_select.h"
#if (TARGET_BOARD == TARGET_BOARD_RSK)

#include <stdio.h>
#include <fcntl.h>

#include "r_typedefs.h"
#include "iodefine_cfg.h"
#include "r_camera_if.h"
#include "r_camera_ov5642.h"
#include "r_os_abstraction_api.h"
#include "control.h"
#include "r_devlink_wrapper.h"
#include "r_riic_drv_sc_cfg.h"
// TODO RC #include "riic_ch1_if.h"

/***********************************************************************************************************************
 Macro definitions
 ***********************************************************************************************************************/
#define SIZE_640x480 1
#define OV5642_SIZE SIZE_640x480

/***********************************************************************************************************************
 Global variables and functions
 ***********************************************************************************************************************/
static void write_omni_table (const omniregister_t Table[]);

/* For more information on the OV7670 camera, please visit the Omnivision web site */
/* http://www.ovt.com */

static const omniregister_t omni_common_regs[] =
{
        {0x31, 0x03, 0x93},
        {0x30, 0x08, 0x82},
        {0x30, 0x17, 0x7f},
        {0x30, 0x18, 0xfc},
        {0x38, 0x10, 0xc2},
        {0x36, 0x15, 0xf0},
        {0x30, 0x00, 0x00},
        {0x30, 0x01, 0x00},
        {0x30, 0x02, 0x00},
        {0x30, 0x03, 0x00},
        {0x30, 0x00, 0xf8},
        {0x30, 0x01, 0x48},
        {0x30, 0x02, 0x5c},
        {0x30, 0x03, 0x02},
        {0x30, 0x04, 0x07},
        {0x30, 0x05, 0xb7},
        {0x30, 0x06, 0x43},
        {0x30, 0x07, 0x37},
#if ( OV5642_SIZE == SIZE_640x480 )
        {0x30, 0x11, 0x10},    /* PLL   0x10 : 30fps */
#elif ( OV5642_SIZE == SIZE_1280x720 || OV5642_SIZE == SIZE_1280x960 || OV5642_SIZE == SIZE_800x600 )
        {0x30, 0x11, 0x08},    /* PLL   0x08 : 15fps */
#endif
        {0x30, 0x10, 0x10},
        {0x46, 0x0c, 0x22},
/* 隠しレジスタ  VGA以下の場合、0ｘ04 SVGAの場合、0ｘ02 */
#if ( OV5642_SIZE == SIZE_640x480 )
        {0x38, 0x15, 0x04},    /* DVPHO 640 x DVPVO 480 */
#elif ( OV5642_SIZE == SIZE_800x600 )
        {0x38, 0x15, 0x02},    /* DVPHO 800 x DVPVO 600 */
#elif ( OV56, 0x42_SIZE == SIZE_1280x720 )
        {0x38, 0x15, 0x02},    /* DVPHO 1280 x DVPVO 720 */
#elif ( OV5642_SIZE == SIZE_1280x960 )
        {0x38, 0x15, 0x02},    /* DVPHO 1280 x DVPVO 960 */
#endif
        {0x37, 0x0d, 0x06},
        {0x37, 0x0c, 0xa0},
        {0x36, 0x02, 0xfc},
        {0x36, 0x12, 0xff},
        {0x36, 0x34, 0xc0},
        {0x36, 0x13, 0x00},
        {0x36, 0x05, 0x7c},
        {0x36, 0x21, 0x09},
        {0x36, 0x22, 0x00},
        {0x36, 0x04, 0x40},
        {0x36, 0x03, 0xa7},
        {0x36, 0x03, 0x27},
        {0x40, 0x00, 0x21},
        {0x40, 0x1d, 0x02},
        {0x36, 0x00, 0x54},
        {0x36, 0x05, 0x04},
        {0x36, 0x06, 0x3f},
        {0x3c, 0x01, 0x00},
        {0x50, 0x00, 0x4f},
        {0x50, 0x20, 0x04},
        {0x51, 0x81, 0x79},
        {0x51, 0x82, 0x00},
        {0x51, 0x85, 0x22},
        {0x51, 0x97, 0x01},
        {0x50, 0x01, 0xff},
        {0x55, 0x00, 0x0a},
        {0x55, 0x04, 0x00},
        {0x55, 0x05, 0x7f},
        {0x50, 0x80, 0x08},
        {0x30, 0x0e, 0x18},
        {0x46, 0x10, 0x00},
        {0x47, 0x1d, 0x05},
        {0x47, 0x08, 0x06},
        {0x37, 0x10, 0x10},
        {0x36, 0x32, 0x41},
        {0x37, 0x02, 0x40},
        {0x36, 0x20, 0x37},
        {0x36, 0x31, 0x01},

/* Output size(scaling) */
#if ( OV5642_SIZE == SIZE_640x480 )
        /* DVPHO 640*/
        {0x38, 0x08, 0x02},
        {0x38, 0x09, 0x80},
        /* DVPVO 480 */
        {0x38, 0x0a, 0x01},
        {0x38, 0x0b, 0xe0},

#elif ( OV5642_SIZE == SIZE_800x600 )
        /* DVPHO 800*/
        {0x38, 0x08, 0x03},
        {0x38, 0x09, 0x20},
        /* DVPVO 600 */
        {0x38, 0x0a, 0x02},
        {0x38, 0x0b, 0x58},

#elif ( OV5642_SIZE == SIZE_1280x720 )
        /* DVPHO 1280*/
        {0x38, 0x08, 0x05},
        {0x38, 0x09, 0x00},
        /* DVPVO 720 */
        {0x38, 0x0a, 0x02},
        {0x38, 0x0b, 0xd0},

#elif ( OV5642_SIZE == SIZE_1280x960 )
        /* DVPHO 1280*/
        {0x38, 0x08, 0x05},
        {0x38, 0x09, 0x00},
        /* DVPVO 960 */
        {0x38, 0x0a, 0x03},
        {0x38, 0x0b, 0xc0},
#endif
        /* H total */
        {0x38, 0x0c, 0x0c},    /* HTS  3200  0x0c80 */
        {0x38, 0x0d, 0x80},    /* Cencer total H    */
        /* V total */
        {0x38, 0x0e, 0x07},    /* VTS  2000  0x07d0 */
        {0x38, 0x0f, 0xd0},    /* Cencer total V    */

        {0x50, 0x1f, 0x00},
        {0x50, 0x00, 0x4f},
        {0x43, 0x00, 0x30},
        {0x35, 0x03, 0x07},
        {0x35, 0x01, 0x73},
        {0x35, 0x02, 0x80},
        {0x35, 0x0b, 0x00},
        {0x35, 0x03, 0x07},
        {0x38, 0x24, 0x11},
        {0x35, 0x01, 0x1e},
        {0x35, 0x02, 0x80},
        {0x35, 0x0b, 0x7f},
        {0x38, 0x0c, 0x0c},
        {0x38, 0x0d, 0x80},
        {0x38, 0x0e, 0x03},
        {0x38, 0x0f, 0xe8},
        {0x3a, 0x0d, 0x04},
        {0x3a, 0x0e, 0x03},
        {0x38, 0x18, 0xe1},
        {0x37, 0x05, 0xdb},
        {0x37, 0x0a, 0x81},
        {0x38, 0x01, 0x80},
        {0x36, 0x21, 0xc7},
        {0x38, 0x01, 0x50},
        {0x38, 0x03, 0x08},
        {0x38, 0x27, 0x08},
        {0x38, 0x10, 0xc0},
#if ( OV5642_SIZE == SIZE_1280x720 )
        {0x38, 0x00, 0x00},   /* HS         */
        {0x38, 0x01, 0x50},   /* 80 0x50    */
        {0x38, 0x02, 0x00},   /* VS         */
        {0x38, 0x03, 0xf8},   /* 8 + 240 = 248 (0x00f8)  */

        {0x38, 0x04, 0x05},   /* HW         */
        {0x38, 0x05, 0x00},   /* 1280 0x500 */
        {0x56, 0x82, 0x05},
        {0x56, 0x83, 0x00},
        {0x38, 0x06, 0x02},   /* VH         */
        {0x38, 0x07, 0xd0},   /* 960- 240 = 720(0x02d0)  */
        {0x56, 0x86, 0x02},
        {0x56, 0x87, 0xd0},
#elif ( OV5642_SIZE == SIZE_1280x960 || OV5642_SIZE == SIZE_800x600 || OV5642_SIZE == SIZE_640x480 )
        {0x38, 0x00, 0x00},   /* HS         */
        {0x38, 0x01, 0x50},   /* 80 0x50    */
        {0x38, 0x02, 0x00},   /* VS         */
        {0x38, 0x03, 0x08},   /* 8          */

        {0x38, 0x04, 0x05},   /* HW         */
        {0x38, 0x05, 0x00},   /* 1280 0x500 */
        {0x56, 0x82, 0x05},
        {0x56, 0x83, 0x00},
        {0x38, 0x06, 0x03},   /* VH         */
        {0x38, 0x07, 0xc0},   /* 960 (0x03C0)  */
        {0x56, 0x86, 0x03},
        {0x56, 0x87, 0xc0},
#endif
        {0x3a, 0x00, 0x78},
        {0x3a, 0x1a, 0x04},
        {0x3a, 0x13, 0x30},
        {0x3a, 0x18, 0x00},
        {0x3a, 0x19, 0x7c},
        {0x3a, 0x08, 0x12},
        {0x3a, 0x09, 0xc0},
        {0x3a, 0x0a, 0x0f},
        {0x3a, 0x0b, 0xa0},
        {0x30, 0x04, 0xff},
        {0x35, 0x0c, 0x07},
        {0x35, 0x0d, 0xd0},
        {0x35, 0x00, 0x00},
        {0x35, 0x01, 0x00},
        {0x35, 0x02, 0x00},
        {0x35, 0x0a, 0x00},
        {0x35, 0x0b, 0x00},
        {0x35, 0x03, 0x00},
        {0x52, 0x8a, 0x02},
        {0x52, 0x8b, 0x04},
        {0x52, 0x8c, 0x08},
        {0x52, 0x8d, 0x08},
        {0x52, 0x8e, 0x08},
        {0x52, 0x8f, 0x10},
        {0x52, 0x90, 0x10},
        {0x52, 0x92, 0x00},
        {0x52, 0x93, 0x02},
        {0x52, 0x94, 0x00},
        {0x52, 0x95, 0x02},
        {0x52, 0x96, 0x00},
        {0x52, 0x97, 0x02},
        {0x52, 0x98, 0x00},
        {0x52, 0x99, 0x02},
        {0x52, 0x9a, 0x00},
        {0x52, 0x9b, 0x02},
        {0x52, 0x9c, 0x00},
        {0x52, 0x9d, 0x02},
        {0x52, 0x9e, 0x00},
        {0x52, 0x9f, 0x02},
        {0x3a, 0x0f, 0x3c},
        {0x3a, 0x10, 0x30},
        {0x3a, 0x1b, 0x3c},
        {0x3a, 0x1e, 0x30},
        {0x3a, 0x11, 0x70},
        {0x3a, 0x1f, 0x10},
        {0x30, 0x30, 0x0b},
        {0x3a, 0x02, 0x00},
        {0x3a, 0x03, 0x7d},
        {0x3a, 0x04, 0x00},
        {0x3a, 0x14, 0x00},
        {0x3a, 0x15, 0x7d},
        {0x3a, 0x16, 0x00},
        {0x3a, 0x08, 0x09},
        {0x3a, 0x09, 0x60},
        {0x3a, 0x0a, 0x07},
        {0x3a, 0x0b, 0xd0},
        {0x3a, 0x0d, 0x08},
        {0x3a, 0x0e, 0x06},
        {0x51, 0x93, 0x70},
        {0x36, 0x20, 0x57},
        {0x37, 0x03, 0x98},
        {0x37, 0x04, 0x1c},
        {0x58, 0x9b, 0x04},
        {0x58, 0x9a, 0xc5},
        {0x52, 0x8a, 0x00},
        {0x52, 0x8b, 0x02},
        {0x52, 0x8c, 0x08},
        {0x52, 0x8d, 0x10},
        {0x52, 0x8e, 0x20},
        {0x52, 0x8f, 0x28},
        {0x52, 0x90, 0x30},
        {0x52, 0x92, 0x00},
        {0x52, 0x93, 0x00},
        {0x52, 0x94, 0x00},
        {0x52, 0x95, 0x02},
        {0x52, 0x96, 0x00},
        {0x52, 0x97, 0x08},
        {0x52, 0x98, 0x00},
        {0x52, 0x99, 0x10},
        {0x52, 0x9a, 0x00},
        {0x52, 0x9b, 0x20},
        {0x52, 0x9c, 0x00},
        {0x52, 0x9d, 0x28},
        {0x52, 0x9e, 0x00},
        {0x52, 0x9f, 0x30},
        {0x52, 0x82, 0x00},
        {0x53, 0x00, 0x00},
        {0x53, 0x01, 0x20},
        {0x53, 0x02, 0x00},
        {0x53, 0x03, 0x7c},
        {0x53, 0x0c, 0x00},
        {0x53, 0x0d, 0x0c},
        {0x53, 0x0e, 0x20},
        {0x53, 0x0f, 0x80},
        {0x53, 0x10, 0x20},
        {0x53, 0x11, 0x80},
        {0x53, 0x08, 0x20},
        {0x53, 0x09, 0x40},
        {0x53, 0x04, 0x00},
        {0x53, 0x05, 0x30},
        {0x53, 0x06, 0x00},
        {0x53, 0x07, 0x80},
        {0x53, 0x14, 0x08},
        {0x53, 0x15, 0x20},
        {0x53, 0x19, 0x30},
        {0x53, 0x16, 0x10},
        {0x53, 0x17, 0x08},
        {0x53, 0x18, 0x02},
        {0x53, 0x80, 0x01},
        {0x53, 0x81, 0x00},
        {0x53, 0x82, 0x00},
        {0x53, 0x83, 0x4e},
        {0x53, 0x84, 0x00},
        {0x53, 0x85, 0x0f},
        {0x53, 0x86, 0x00},
        {0x53, 0x87, 0x00},
        {0x53, 0x88, 0x01},
        {0x53, 0x89, 0x15},
        {0x53, 0x8a, 0x00},
        {0x53, 0x8b, 0x31},
        {0x53, 0x8c, 0x00},
        {0x53, 0x8d, 0x00},
        {0x53, 0x8e, 0x00},
        {0x53, 0x8f, 0x0f},
        {0x53, 0x90, 0x00},
        {0x53, 0x91, 0xab},
        {0x53, 0x92, 0x00},
        {0x53, 0x93, 0xa2},
        {0x53, 0x94, 0x08},
        {0x54, 0x80, 0x14},
        {0x54, 0x81, 0x21},
        {0x54, 0x82, 0x36},
        {0x54, 0x83, 0x57},
        {0x54, 0x84, 0x65},
        {0x54, 0x85, 0x71},
        {0x54, 0x86, 0x7d},
        {0x54, 0x87, 0x87},
        {0x54, 0x88, 0x91},
        {0x54, 0x89, 0x9a},
        {0x54, 0x8a, 0xaa},
        {0x54, 0x8b, 0xb8},
        {0x54, 0x8c, 0xcd},
        {0x54, 0x8d, 0xdd},
        {0x54, 0x8e, 0xea},
        {0x54, 0x8f, 0x10},
        {0x54, 0x90, 0x05},
        {0x54, 0x91, 0x00},
        {0x54, 0x92, 0x04},
        {0x54, 0x93, 0x20},
        {0x54, 0x94, 0x03},
        {0x54, 0x95, 0x60},
        {0x54, 0x96, 0x02},
        {0x54, 0x97, 0xb8},
        {0x54, 0x98, 0x02},
        {0x54, 0x99, 0x86},
        {0x54, 0x9a, 0x02},
        {0x54, 0x9b, 0x5b},
        {0x54, 0x9c, 0x02},
        {0x54, 0x9d, 0x3b},
        {0x54, 0x9e, 0x02},
        {0x54, 0x9f, 0x1c},
        {0x54, 0xa0, 0x02},
        {0x54, 0xa1, 0x04},
        {0x54, 0xa2, 0x01},
        {0x54, 0xa3, 0xed},
        {0x54, 0xa4, 0x01},
        {0x54, 0xa5, 0xc5},
        {0x54, 0xa6, 0x01},
        {0x54, 0xa7, 0xa5},
        {0x54, 0xa8, 0x01},
        {0x54, 0xa9, 0x6c},
        {0x54, 0xaa, 0x01},
        {0x54, 0xab, 0x41},
        {0x54, 0xac, 0x01},
        {0x54, 0xad, 0x20},
        {0x54, 0xae, 0x00},
        {0x54, 0xaf, 0x16},
        {0x34, 0x06, 0x00},
        {0x51, 0x92, 0x04},
        {0x51, 0x91, 0xf8},
        {0x51, 0x93, 0x70},
        {0x51, 0x94, 0xf0},
        {0x51, 0x95, 0xf0},
        {0x51, 0x8d, 0x3d},
        {0x51, 0x8f, 0x54},
        {0x51, 0x8e, 0x3d},
        {0x51, 0x90, 0x54},
        {0x51, 0x8b, 0xc0},
        {0x51, 0x8c, 0xbd},
        {0x51, 0x87, 0x18},
        {0x51, 0x88, 0x18},
        {0x51, 0x89, 0x6e},
        {0x51, 0x8a, 0x68},
        {0x51, 0x86, 0x1c},
        {0x51, 0x81, 0x50},
        {0x51, 0x84, 0x25},
        {0x51, 0x82, 0x11},
        {0x51, 0x83, 0x14},
        {0x51, 0x84, 0x25},
        {0x51, 0x85, 0x24},
        {0x50, 0x25, 0x82},
        {0x3a, 0x0f, 0x7e},
        {0x3a, 0x10, 0x72},
        {0x3a, 0x1b, 0x80},
        {0x3a, 0x1e, 0x70},
        {0x3a, 0x11, 0xd0},
        {0x3a, 0x1f, 0x40},
        {0x55, 0x83, 0x40},
        {0x55, 0x84, 0x40},
        {0x55, 0x80, 0x02},
        {0x36, 0x33, 0x07},
        {0x37, 0x02, 0x10},
        {0x37, 0x03, 0xb2},
        {0x37, 0x04, 0x18},
        {0x37, 0x0b, 0x40},
        {0x37, 0x0d, 0x02},
        {0x36, 0x20, 0x52},
        {0x50, 0x3d, 0x00},   /* add color bar off */
        {0x50, 0x3e, 0x00},   /*               */

    {0xff, 0xff, 0xff}                    /* structure end marker */
};

/***********************************************************************************************************************
 * Function Name: write_omni_table
 * Description  : Programs Omnivision camera configuration registers.
 * Arguments    : Table - Pointer to a table containing the configuration.
 * Return Value : void
 ***********************************************************************************************************************/

static void write_omni_table (const omniregister_t Table[])
{
    uint16_t i;
    st_r_drv_riic_config_t i2c_write;
    st_r_drv_riic_create_t riic_clock;
    int_t hi2c1 = ( -1);
    int_t error = -1;
    uint8_t reg_data[2];

    hi2c1 = open(DEVICE_INDENTIFIER "iic0", O_RDWR);

    if (( -1) == hi2c1)
    {
        /* error */
    }
    else
    {
        riic_clock.frequency = RIIC_FREQUENCY_100KHZ;
        error = control(hi2c1, CTL_RIIC_CREATE, &riic_clock);
        if (0 > error)
        {
            /* error */
        }
        else
        {
            for (i = 0; ((0xff != Table[i].addr_h) || (0xff != Table[i].addr_l) || (0xff != Table[i].val)); i++)
            {
                i2c_write.device_address = OV5642_I2C_ADDR;
                i2c_write.sub_address = Table[i].addr_h;
                i2c_write.number_of_bytes = 2;
                reg_data[0] = Table[i].addr_l;
                reg_data[1] = Table[i].val;
                i2c_write.p_data_buffer = reg_data;
                error = control(hi2c1, CTL_RIIC_WRITE, &i2c_write);
                if (0 > error)
                {
                    /* error */
                    break;
                }
            }
        }
        close(hi2c1);
    }
}

/***********************************************************************************************************************
 End of Function write_omni_table
 ***********************************************************************************************************************/

/***********************************************************************************************************************
 * Function Name: R_CAMERA_Ov5642Init
 * Description  : API function to initialise the OV5642 camera.
 * Arguments    : videoResolution
 * Return Value : void
 ***********************************************************************************************************************/
void R_CAMERA_Ov5642Init (int videoResolution)
{
    R_OS_TaskSleep(5);

    /* Write the default values in the camera module */
    write_omni_table(omni_common_regs);

}
/***********************************************************************************************************************
 End of Function R_CAMERA_Ov5642Init
 ***********************************************************************************************************************/
#else
#endif
